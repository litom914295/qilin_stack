"""
å¢å¼ºç‰ˆåˆ†ææŠ¥å‘Šç”Ÿæˆå™¨
æ”¯æŒå›¢é˜Ÿè¾©è®ºè®°å½•ã€è¯¦ç»†åˆ†ææ¨¡å—å’Œå¤šç§å®ç”¨è‚¡ç¥¨å†³ç­–å†…å®¹
"""

from datetime import datetime
from typing import Dict, Any, List, Optional
import json


class EnhancedReportGenerator:
    """å¢å¼ºç‰ˆæŠ¥å‘Šç”Ÿæˆå™¨"""
    
    def __init__(self):
        self.timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    
    def _clean_text(self, text: Any) -> str:
        """æ¸…ç†æ–‡æœ¬"""
        if text is None:
            return "æš‚æ— æ•°æ®"
        return str(text).strip()
    
    def generate_full_report(self, 
                           symbol: str,
                           result: Dict[str, Any],
                           depth: str = "æ ‡å‡†") -> str:
        """
        ç”Ÿæˆå®Œæ•´çš„åˆ†ææŠ¥å‘Š
        
        Args:
            symbol: è‚¡ç¥¨ä»£ç 
            result: åˆ†æç»“æœå­—å…¸
            depth: åˆ†ææ·±åº¦
            
        Returns:
            å®Œæ•´çš„Markdownæ ¼å¼æŠ¥å‘Š
        """
        
        consensus = result.get('consensus', {})
        signal = consensus.get('signal', 'HOLD')
        confidence = consensus.get('confidence', 0.0)
        reasoning = consensus.get('reasoning', '')
        individual_results = result.get('individual_results', [])
        
        # è®¡ç®—é£é™©ç­‰çº§
        risk_level = self._calculate_risk_level(confidence)
        
        # ç»Ÿè®¡æ™ºèƒ½ä½“è§‚ç‚¹
        buy_count = sum(1 for x in individual_results if (x.get('signal') or 'HOLD').upper() == 'BUY')
        sell_count = sum(1 for x in individual_results if (x.get('signal') or 'HOLD').upper() == 'SELL')
        hold_count = sum(1 for x in individual_results if (x.get('signal') or 'HOLD').upper() == 'HOLD')
        
        # æ„å»ºæŠ¥å‘Š
        report = f"""# ğŸ“Š {symbol} æ·±åº¦æŠ•èµ„åˆ†ææŠ¥å‘Š

**ç”Ÿæˆæ—¶é—´**: {self.timestamp}  
**åˆ†ææ·±åº¦**: {depth}  
**å‚ä¸æ™ºèƒ½ä½“**: {len(individual_results)}ä¸ª  
**åˆ†ææ¨¡å¼**: å¤šæ™ºèƒ½ä½“åä½œå†³ç­–  

---

## ğŸ¯ æ‰§è¡Œæ‘˜è¦

### æ ¸å¿ƒç»“è®º

| æŒ‡æ ‡ | ç»“æœ |
|------|------|
| **æœ€ç»ˆå»ºè®®** | {self._format_signal(signal)} |
| **ç»¼åˆè¯„åˆ†** | {confidence*100:.1f}/100 |
| **é£é™©ç­‰çº§** | {risk_level} |
| **æ™ºèƒ½ä½“å…±è¯†åº¦** | {max(buy_count, sell_count, hold_count)/len(individual_results)*100:.1f}% |

### åˆ†ææ¨ç†

{reasoning if reasoning else f'ç»è¿‡{len(individual_results)}ä¸ªä¸“ä¸šæ™ºèƒ½ä½“çš„åä½œåˆ†æï¼Œç³»ç»Ÿç»¼åˆè¯„ä¼°åå»ºè®® **{signal}**ï¼Œç»¼åˆç½®ä¿¡åº¦ä¸º **{confidence*100:.1f}%**ã€‚'}

---

## ğŸ‘¥ æ™ºèƒ½ä½“åä½œåˆ†æ

### è§‚ç‚¹åˆ†å¸ƒç»Ÿè®¡

- ğŸŸ¢ **ä¹°å…¥ (BUY)**: {buy_count}ä¸ªæ™ºèƒ½ä½“ ({buy_count/len(individual_results)*100:.0f}%)
- ğŸ”´ **å–å‡º (SELL)**: {sell_count}ä¸ªæ™ºèƒ½ä½“ ({sell_count/len(individual_results)*100:.0f}%)
- ğŸŸ¡ **æŒæœ‰ (HOLD)**: {hold_count}ä¸ªæ™ºèƒ½ä½“ ({hold_count/len(individual_results)*100:.0f}%)

"""
        
        # æ·»åŠ å„æ™ºèƒ½ä½“è¯¦ç»†åˆ†æ
        report += self._generate_agents_analysis(individual_results)
        
        # æ·»åŠ å›¢é˜Ÿè¾©è®ºè®°å½•
        report += self._generate_team_debate(individual_results)
        
        # æ·»åŠ è¯¦ç»†åˆ†ææ¨¡å—
        report += self._generate_detailed_analysis_modules(symbol, result, individual_results)
        
        # æ·»åŠ æŠ•èµ„å†³ç­–å»ºè®®
        report += self._generate_investment_advice(signal, confidence, individual_results)
        
        # æ·»åŠ é£é™©è¯„ä¼°
        report += self._generate_risk_assessment(confidence, individual_results)
        
        # æ·»åŠ å…è´£å£°æ˜
        report += self._generate_disclaimer()
        
        return report
    
    def _format_signal(self, signal: str) -> str:
        """æ ¼å¼åŒ–ä¿¡å·æ˜¾ç¤º"""
        signal_map = {
            'BUY': 'ğŸŸ¢ ä¹°å…¥',
            'SELL': 'ğŸ”´ å–å‡º',
            'HOLD': 'ğŸŸ¡ æŒæœ‰'
        }
        return signal_map.get(signal.upper(), signal)
    
    def _calculate_risk_level(self, confidence: float) -> str:
        """è®¡ç®—é£é™©ç­‰çº§"""
        if confidence < 0.5:
            return "âš ï¸ é«˜é£é™©"
        elif confidence < 0.75:
            return "âš¡ ä¸­ç­‰é£é™©"
        else:
            return "âœ… ä½é£é™©"
    
    def _generate_agents_analysis(self, individual_results: List[Dict]) -> str:
        """ç”Ÿæˆå„æ™ºèƒ½ä½“è¯¦ç»†åˆ†æ"""
        
        content = """### å„æ™ºèƒ½ä½“è¯¦ç»†è§‚ç‚¹

"""
        
        for idx, agent_result in enumerate(individual_results, 1):
            agent_name = agent_result.get('agent', f'Agent{idx}')
            agent_signal = (agent_result.get('signal') or 'HOLD').upper()
            agent_conf = agent_result.get('confidence', 0.0)
            agent_reasoning = agent_result.get('reasoning', 'æš‚æ— è¯¦ç»†åˆ†æ')
            
            signal_emoji = "ğŸŸ¢" if agent_signal == 'BUY' else "ğŸ”´" if agent_signal == 'SELL' else "ğŸŸ¡"
            
            content += f"""
#### {idx}. {agent_name}

**è§‚ç‚¹**: {signal_emoji} {agent_signal}  
**ç½®ä¿¡åº¦**: {agent_conf*100:.1f}%

**åˆ†æç†ç”±**:
{agent_reasoning}

"""
        
        return content + "\n---\n\n"
    
    def _generate_team_debate(self, individual_results: List[Dict]) -> str:
        """ç”Ÿæˆå›¢é˜Ÿè¾©è®ºè®°å½•"""
        
        # åˆ†ç¦»å¤šå¤´å’Œç©ºå¤´è§‚ç‚¹
        bull_agents = [x for x in individual_results if (x.get('signal') or 'HOLD').upper() == 'BUY']
        bear_agents = [x for x in individual_results if (x.get('signal') or 'HOLD').upper() == 'SELL']
        neutral_agents = [x for x in individual_results if (x.get('signal') or 'HOLD').upper() == 'HOLD']
        
        content = """## ğŸ”¬ ç ”ç©¶å›¢é˜Ÿè¾©è®ºè®°å½•

*æ¨¡æ‹Ÿå¤šå¤´/ç©ºå¤´ç ”ç©¶å‘˜çš„ä¸“ä¸šè¾©è®ºè¿‡ç¨‹*

"""
        
        # å¤šå¤´ç ”ç©¶å‘˜åˆ†æ
        if bull_agents:
            content += f"""### ğŸ“ˆ å¤šå¤´ç ”ç©¶å‘˜å›¢é˜Ÿ ({len(bull_agents)}äºº)

**æ ¸å¿ƒè§‚ç‚¹**: çœ‹æ¶¨ï¼Œå»ºè®®ä¹°å…¥

**ä¸»è¦è®ºæ®**:

"""
            for idx, agent in enumerate(bull_agents, 1):
                content += f"""
**{idx}. {agent.get('agent', 'Analyst')}** (ç½®ä¿¡åº¦: {agent.get('confidence', 0)*100:.1f}%)

{agent.get('reasoning', 'è¯¦ç»†åˆ†æå¾…è¡¥å……...')}

"""
        
        # ç©ºå¤´ç ”ç©¶å‘˜åˆ†æ
        if bear_agents:
            content += f"""
### ğŸ“‰ ç©ºå¤´ç ”ç©¶å‘˜å›¢é˜Ÿ ({len(bear_agents)}äºº)

**æ ¸å¿ƒè§‚ç‚¹**: çœ‹è·Œï¼Œå»ºè®®å–å‡º

**ä¸»è¦è®ºæ®**:

"""
            for idx, agent in enumerate(bear_agents, 1):
                content += f"""
**{idx}. {agent.get('agent', 'Analyst')}** (ç½®ä¿¡åº¦: {agent.get('confidence', 0)*100:.1f}%)

{agent.get('reasoning', 'è¯¦ç»†åˆ†æå¾…è¡¥å……...')}

"""
        
        # ä¸­ç«‹åˆ†æå¸ˆ
        if neutral_agents:
            content += f"""
### âš–ï¸ ä¸­ç«‹ç ”ç©¶å‘˜å›¢é˜Ÿ ({len(neutral_agents)}äºº)

**æ ¸å¿ƒè§‚ç‚¹**: æŒæœ‰è§‚æœ›ï¼Œç­‰å¾…æ›´æ˜ç¡®ä¿¡å·

**ä¸»è¦è®ºæ®**:

"""
            for idx, agent in enumerate(neutral_agents, 1):
                content += f"""
**{idx}. {agent.get('agent', 'Analyst')}** (ç½®ä¿¡åº¦: {agent.get('confidence', 0)*100:.1f}%)

{agent.get('reasoning', 'è¯¦ç»†åˆ†æå¾…è¡¥å……...')}

"""
        
        # ç ”ç©¶ç»ç†ç»¼åˆå†³ç­–
        content += f"""
### ğŸ¯ ç ”ç©¶ç»ç†ç»¼åˆå†³ç­–

**å†³ç­–è¿‡ç¨‹**:

ç»è¿‡å¤šè½®è¾©è®ºå’Œæ·±å…¥è®¨è®ºï¼Œç ”ç©¶ç»ç†ç»¼åˆè€ƒè™‘äº†{len(individual_results)}ä½åˆ†æå¸ˆçš„ä¸“ä¸šæ„è§ï¼š

- å¤šå¤´é˜µè¥: {len(bull_agents)}äººï¼Œå æ¯”{len(bull_agents)/len(individual_results)*100:.1f}%
- ç©ºå¤´é˜µè¥: {len(bear_agents)}äººï¼Œå æ¯”{len(bear_agents)/len(individual_results)*100:.1f}%
- ä¸­ç«‹è§‚æœ›: {len(neutral_agents)}äººï¼Œå æ¯”{len(neutral_agents)/len(individual_results)*100:.1f}%

**æœ€ç»ˆç»“è®º**:

åŸºäºå›¢é˜Ÿè¾©è®ºçš„ç»“æœå’Œå¸‚åœºå®é™…æƒ…å†µï¼Œç ”ç©¶ç»ç†è®¤ä¸ºï¼š

"""
        
        # æ ¹æ®å¤šæ•°æ„è§ç»™å‡ºç»“è®º
        if len(bull_agents) > len(bear_agents) and len(bull_agents) > len(neutral_agents):
            content += """
å½“å‰å¤šå¤´è§‚ç‚¹å æ®ä¼˜åŠ¿ï¼Œå¸‚åœºæƒ…ç»ªè¾ƒä¸ºä¹è§‚ã€‚å»ºè®®æŠ•èµ„è€…å¯ä»¥è€ƒè™‘é€‚åº¦å‚ä¸ï¼Œä½†éœ€æ³¨æ„æ§åˆ¶ä»“ä½å’Œè®¾ç½®æ­¢æŸã€‚
"""
        elif len(bear_agents) > len(bull_agents) and len(bear_agents) > len(neutral_agents):
            content += """
å½“å‰ç©ºå¤´è§‚ç‚¹å æ®ä¼˜åŠ¿ï¼Œå¸‚åœºå­˜åœ¨è¾ƒå¤§é£é™©ã€‚å»ºè®®æŠ•èµ„è€…è°¨æ…å‚ä¸ï¼Œå·²æŒæœ‰ä»“ä½çš„å¯ä»¥è€ƒè™‘é€æ­¥å‡ä»“æˆ–è®¾ç½®ä¸¥æ ¼æ­¢æŸã€‚
"""
        else:
            content += """
å½“å‰å›¢é˜Ÿå†…éƒ¨åˆ†æ­§è¾ƒå¤§ï¼Œå¸‚åœºæ–¹å‘ä¸å¤Ÿæ˜ç¡®ã€‚å»ºè®®æŠ•èµ„è€…ä¿æŒè§‚æœ›ï¼Œç­‰å¾…æ›´æ¸…æ™°çš„ä¿¡å·å†åšå†³ç­–ã€‚
"""
        
        return content + "\n---\n\n"
    
    def _generate_detailed_analysis_modules(self, 
                                          symbol: str,
                                          result: Dict[str, Any],
                                          individual_results: List[Dict]) -> str:
        """ç”Ÿæˆè¯¦ç»†åˆ†ææ¨¡å—"""
        
        content = """## ğŸ“Š è¯¦ç»†åˆ†ææ¨¡å—

"""
        
        # 1. å¸‚åœºæŠ€æœ¯åˆ†æ
        content += """### ğŸ“ˆ å¸‚åœºæŠ€æœ¯åˆ†æ

**æŠ€æœ¯æŒ‡æ ‡è§£è¯»**:

"""
        
        # ä»æ™ºèƒ½ä½“ç»“æœä¸­æå–æŠ€æœ¯åˆ†æç›¸å…³å†…å®¹
        tech_agents = [x for x in individual_results if 'æŠ€æœ¯' in x.get('agent', '') or 'technical' in x.get('agent', '').lower()]
        if tech_agents:
            for agent in tech_agents:
                content += f"- {agent.get('reasoning', 'æš‚æ— æŠ€æœ¯åˆ†ææ•°æ®')}\n\n"
        else:
            content += """
- **è¶‹åŠ¿åˆ†æ**: åŸºäºç§»åŠ¨å¹³å‡çº¿å’Œè¶‹åŠ¿æŒ‡æ ‡åˆ¤æ–­å½“å‰è¶‹åŠ¿
- **æ”¯æ’‘é˜»åŠ›**: è¯†åˆ«å…³é”®ä»·æ ¼ä½ï¼Œä¸ºäº¤æ˜“å†³ç­–æä¾›å‚è€ƒ
- **åŠ¨é‡æŒ‡æ ‡**: RSIã€MACDç­‰æŒ‡æ ‡æ˜¾ç¤ºå¸‚åœºåŠ¨èƒ½çŠ¶æ€
- **æˆäº¤é‡åˆ†æ**: é‡ä»·é…åˆæƒ…å†µï¼ŒéªŒè¯è¶‹åŠ¿æœ‰æ•ˆæ€§

*æ³¨: è¯¦ç»†æŠ€æœ¯æŒ‡æ ‡æ•°æ®éœ€è¦å®æ—¶å¸‚åœºæ•°æ®æ”¯æŒ*

"""
        
        # 2. åŸºæœ¬é¢åˆ†æ
        content += """
### ğŸ’° åŸºæœ¬é¢åˆ†æ

**è´¢åŠ¡çŠ¶å†µè¯„ä¼°**:

"""
        
        fundamental_agents = [x for x in individual_results if 'åŸºæœ¬é¢' in x.get('agent', '') or 'fundamental' in x.get('agent', '').lower()]
        if fundamental_agents:
            for agent in fundamental_agents:
                content += f"- {agent.get('reasoning', 'æš‚æ— åŸºæœ¬é¢åˆ†æ')}\n\n"
        else:
            content += """
- **ç›ˆåˆ©èƒ½åŠ›**: åˆ†æå…¬å¸çš„ç›ˆåˆ©è´¨é‡å’Œå¢é•¿æ½œåŠ›
- **è´¢åŠ¡å¥åº·**: è¯„ä¼°èµ„äº§è´Ÿå€ºçŠ¶å†µå’Œç°é‡‘æµæƒ…å†µ
- **ä¼°å€¼æ°´å¹³**: å¯¹æ¯”è¡Œä¸šå¹³å‡æ°´å¹³ï¼Œåˆ¤æ–­å½“å‰ä¼°å€¼æ˜¯å¦åˆç†
- **æˆé•¿æ€§**: è€ƒå¯Ÿå…¬å¸ä¸šåŠ¡å‘å±•å‰æ™¯å’Œå¸‚åœºç«äº‰åŠ›

*æ³¨: å®Œæ•´åŸºæœ¬é¢åˆ†æéœ€è¦è·å–æœ€æ–°è´¢æŠ¥æ•°æ®*

"""
        
        # 3. å¸‚åœºæƒ…ç»ªåˆ†æ
        content += """
### ğŸ’­ å¸‚åœºæƒ…ç»ªåˆ†æ

**æŠ•èµ„è€…æƒ…ç»ªæŒ‡æ ‡**:

"""
        
        sentiment_agents = [x for x in individual_results if 'æƒ…ç»ª' in x.get('agent', '') or 'sentiment' in x.get('agent', '').lower()]
        if sentiment_agents:
            for agent in sentiment_agents:
                content += f"- {agent.get('reasoning', 'æš‚æ— æƒ…ç»ªåˆ†æ')}\n\n"
        else:
            content += """
- **ç¤¾äº¤åª’ä½“æƒ…ç»ª**: åˆ†ææŠ•èµ„è€…åœ¨ç¤¾äº¤å¹³å°çš„è®¨è®ºçƒ­åº¦å’Œæƒ…ç»ªå€¾å‘
- **èµ„é‡‘æµå‘**: è§‚å¯Ÿä¸»åŠ›èµ„é‡‘å’Œæ•£æˆ·èµ„é‡‘çš„è¿›å‡ºæƒ…å†µ
- **å¸‚åœºçƒ­åº¦**: è¯„ä¼°è‚¡ç¥¨çš„å…³æ³¨åº¦å’Œäº¤æ˜“æ´»è·ƒç¨‹åº¦
- **æƒ…ç»ªæå€¼**: è¯†åˆ«è¿‡åº¦ä¹è§‚æˆ–æ‚²è§‚çš„æç«¯æƒ…ç»ª

*æ³¨: æƒ…ç»ªåˆ†æéœ€è¦æ¥å…¥ç¤¾äº¤åª’ä½“å’Œèµ„é‡‘æµå‘æ•°æ®*

"""
        
        # 4. é£é™©å› ç´ è¯†åˆ«
        content += """
### âš ï¸ é£é™©å› ç´ è¯†åˆ«

**ä¸»è¦é£é™©ç‚¹**:

"""
        
        risk_agents = [x for x in individual_results if 'é£é™©' in x.get('agent', '') or 'risk' in x.get('agent', '').lower()]
        if risk_agents:
            for agent in risk_agents:
                content += f"- {agent.get('reasoning', 'æš‚æ— é£é™©åˆ†æ')}\n\n"
        else:
            content += """
1. **å¸‚åœºé£é™©**: æ•´ä½“å¸‚åœºæ³¢åŠ¨å¯èƒ½å¸¦æ¥çš„ç³»ç»Ÿæ€§é£é™©
2. **è¡Œä¸šé£é™©**: æ‰€å¤„è¡Œä¸šçš„æ”¿ç­–å˜åŒ–å’Œç«äº‰æ ¼å±€å˜åŒ–
3. **å…¬å¸é£é™©**: ç»è¥é£é™©ã€è´¢åŠ¡é£é™©ã€ç®¡ç†å±‚å˜åŠ¨ç­‰
4. **æµåŠ¨æ€§é£é™©**: äº¤æ˜“é‡ä¸è¶³å¯èƒ½å¯¼è‡´çš„ä¹°å–å›°éš¾
5. **æ”¿ç­–é£é™©**: ç›‘ç®¡æ”¿ç­–å˜åŒ–å¯¹å…¬å¸ä¸šåŠ¡çš„å½±å“

*å»ºè®®: å……åˆ†äº†è§£å¹¶è¯„ä¼°å„ç±»é£é™©åå†åšæŠ•èµ„å†³ç­–*

"""
        
        return content + "\n---\n\n"
    
    def _generate_investment_advice(self, 
                                  signal: str,
                                  confidence: float,
                                  individual_results: List[Dict]) -> str:
        """ç”ŸæˆæŠ•èµ„å†³ç­–å»ºè®®"""
        
        content = """## ğŸ’¼ æŠ•èµ„å†³ç­–å»ºè®®

### å…·ä½“æ“ä½œç­–ç•¥

"""
        
        if signal.upper() == 'BUY':
            content += f"""
**å»ºè®®æ“ä½œ**: ğŸŸ¢ ä¹°å…¥

**ä»“ä½ç®¡ç†**:
- å»ºè®®ä»“ä½: {min(confidence * 50, 30):.0f}% (åŸºäº{confidence*100:.1f}%ç½®ä¿¡åº¦)
- åˆ†æ‰¹å»ºä»“: å»ºè®®åˆ†2-3æ‰¹ä¹°å…¥ï¼Œé™ä½é£é™©
- æ­¢æŸä½ç½®: å»ºè®®è®¾ç½®åœ¨ä¹°å…¥ä»·ä¸‹æ–¹{5 + (1-confidence)*10:.0f}%

**æ—¶æœºé€‰æ‹©**:
- ä¼˜å…ˆè€ƒè™‘: å›è°ƒè‡³æ”¯æ’‘ä½é™„è¿‘æ—¶
- é¿å…è¿½é«˜: ä¸è¦åœ¨å¤§å¹…ä¸Šæ¶¨åç›²ç›®è¿½æ¶¨
- å…³æ³¨é‡èƒ½: æˆäº¤é‡æ”¾å¤§æ—¶ä»‹å…¥æ•ˆæœæ›´ä½³

**æŒæœ‰ç­–ç•¥**:
- çŸ­æœŸç›®æ ‡: é¢„æœŸ{10 + confidence*10:.0f}%æ”¶ç›Š
- ä¸­æœŸç›®æ ‡: é¢„æœŸ{20 + confidence*20:.0f}%æ”¶ç›Š
- æ­¢ç›ˆç­–ç•¥: è¾¾åˆ°ç›®æ ‡ä½åé€æ­¥å‡ä»“

"""
        elif signal.upper() == 'SELL':
            content += f"""
**å»ºè®®æ“ä½œ**: ğŸ”´ å–å‡º

**å‡ä»“ç­–ç•¥**:
- å»ºè®®å‡ä»“: {min(confidence * 80, 100):.0f}% (åŸºäº{confidence*100:.1f}%ç½®ä¿¡åº¦)
- åˆ†æ‰¹å–å‡º: å»ºè®®åˆ†2-3æ‰¹å–å‡ºï¼Œé¿å…è¸ç©º
- æ­¢æŸæ‰§è¡Œ: ä¸¥æ ¼æ‰§è¡Œæ­¢æŸï¼Œé¿å…æŸå¤±æ‰©å¤§

**æ—¶æœºé€‰æ‹©**:
- ä¼˜å…ˆè€ƒè™‘: åå¼¹è‡³é˜»åŠ›ä½é™„è¿‘æ—¶
- æœæ–­ç¦»åœº: è·Œç ´å…³é”®æ”¯æ’‘ä½æ—¶åšå†³å–å‡º
- å‡å°‘æŸå¤±: å·²æœ‰æµ®äºçš„å°½å¿«æ­¢æŸ

**åç»­è§‚å¯Ÿ**:
- è§‚æœ›ç­‰å¾…: æš‚ä¸è€ƒè™‘é‡æ–°ä¹°å…¥
- å…³æ³¨ä¿¡å·: ç­‰å¾…æ˜ç¡®çš„åº•éƒ¨ä¿¡å·
- ä¿æŒçºªå¾‹: ä¸è¦å› ä¸ºæŸå¤±è€Œç›²ç›®è¡¥ä»“

"""
        else:  # HOLD
            content += f"""
**å»ºè®®æ“ä½œ**: ğŸŸ¡ æŒæœ‰è§‚æœ›

**æŒæœ‰ç­–ç•¥**:
- å½“å‰æŒä»“: ç»´æŒä¸å˜ï¼Œä¸å¢ä¸å‡
- ä¿æŒè­¦æƒ•: å¯†åˆ‡å…³æ³¨å¸‚åœºå˜åŒ–å’Œæ–°ä¿¡å·
- è®¾ç½®æé†’: å…³é”®ä»·ä½çªç ´æ—¶åŠæ—¶å†³ç­–

**è§‚æœ›è¦ç‚¹**:
- ç­‰å¾…æ˜ç¡®: ç›®å‰ä¿¡å·ä¸å¤Ÿæ˜ç¡®ï¼Œå»ºè®®è°¨æ…
- ä¸¤æ‰‹å‡†å¤‡: å‡†å¤‡å¥½ä¸Šæ¶¨å’Œä¸‹è·Œçš„åº”å¯¹é¢„æ¡ˆ
- æ­¢æŸä¿æŠ¤: è®¾ç½®é€‚å½“æ­¢æŸï¼Œæ§åˆ¶ä¸‹è¡Œé£é™©

**å†³ç­–è§¦å‘æ¡ä»¶**:
- ä¹°å…¥ä¿¡å·: å¦‚æœæ™ºèƒ½ä½“å…±è¯†åº¦æå‡è‡³>{75}%
- å–å‡ºä¿¡å·: å¦‚æœå‡ºç°æ˜æ˜¾é£é™©æˆ–è·Œç ´å…³é”®ä½
- ç»§ç»­è§‚æœ›: åœ¨ä¿¡å·ä¸æ˜æœ—æ—¶ä¿æŒè€å¿ƒ

"""
        
        # æ·»åŠ èµ„é‡‘ç®¡ç†å»ºè®®
        content += """
### èµ„é‡‘ç®¡ç†åŸåˆ™

1. **ä»“ä½æ§åˆ¶**: å•åªè‚¡ç¥¨ä»“ä½ä¸è¶…è¿‡æ€»èµ„é‡‘çš„30%
2. **é£é™©å¯¹å†²**: è€ƒè™‘é…ç½®ä¸€å®šæ¯”ä¾‹çš„é˜²å¾¡æ€§èµ„äº§
3. **æµåŠ¨æ€§ç®¡ç†**: ä¿ç•™30%ç°é‡‘åº”å¯¹çªå‘æƒ…å†µ
4. **æ­¢æŸçºªå¾‹**: è®¾å®šå¹¶ä¸¥æ ¼æ‰§è¡Œæ­¢æŸè®¡åˆ’
5. **å®šæœŸæ£€æŸ¥**: æ¯å‘¨è¯„ä¼°æŒä»“ï¼ŒåŠæ—¶è°ƒæ•´ç­–ç•¥

"""
        
        return content + "\n---\n\n"
    
    def _generate_risk_assessment(self, 
                                 confidence: float,
                                 individual_results: List[Dict]) -> str:
        """ç”Ÿæˆé£é™©è¯„ä¼°"""
        
        content = """## âš–ï¸ é£é™©è¯„ä¼°ä¸æç¤º

### é£é™©ç­‰çº§è¯„å®š

"""
        
        if confidence < 0.5:
            content += """
**å½“å‰é£é™©ç­‰çº§**: âš ï¸ é«˜é£é™©

**é£é™©æè¿°**:
- æ™ºèƒ½ä½“å…±è¯†ç¨‹åº¦è¾ƒä½ï¼ˆ<50%ï¼‰ï¼Œåˆ†æç»“æœå­˜åœ¨è¾ƒå¤§ä¸ç¡®å®šæ€§
- å¸‚åœºæ–¹å‘ä¸æ˜ç¡®ï¼Œå¯èƒ½å­˜åœ¨è¾ƒå¤§æ³¢åŠ¨
- ä¸å»ºè®®å¤§ä»“ä½å‚ä¸ï¼Œæ–°æ‰‹æŠ•èµ„è€…åº”è°¨æ…è§‚æœ›

**é£é™©æç¤º**:
1. âš ï¸ å¯èƒ½é¢ä¸´è¾ƒå¤§å›æ’¤é£é™©
2. âš ï¸ å¸‚åœºæƒ…ç»ªå¯èƒ½å¿«é€Ÿåè½¬
3. âš ï¸ å»ºè®®ä¸¥æ ¼æ§åˆ¶ä»“ä½ï¼ˆâ‰¤10%ï¼‰
4. âš ï¸ åŠ¡å¿…è®¾ç½®æ­¢æŸä¿æŠ¤
5. âš ï¸ å»ºè®®å¢åŠ åˆ†ææ·±åº¦æˆ–ç­‰å¾…æ›´å¤šæ•°æ®

"""
        elif confidence < 0.75:
            content += """
**å½“å‰é£é™©ç­‰çº§**: âš¡ ä¸­ç­‰é£é™©

**é£é™©æè¿°**:
- æ™ºèƒ½ä½“è¾¾æˆäº†ä¸€å®šå…±è¯†ï¼ˆ50-75%ï¼‰ï¼Œä½†ä»å­˜åœ¨åˆ†æ­§
- å¸‚åœºæ–¹å‘ç›¸å¯¹æ˜ç¡®ï¼Œä½†å¯èƒ½å­˜åœ¨çŸ­æœŸæ³¢åŠ¨
- é€‚åˆæœ‰ä¸€å®šç»éªŒçš„æŠ•èµ„è€…å‚ä¸

**é£é™©æç¤º**:
1. â„¹ï¸ éœ€è¦å…³æ³¨å¸‚åœºæ³¢åŠ¨å’Œè¶‹åŠ¿å˜åŒ–
2. â„¹ï¸ å»ºè®®åˆç†æ§åˆ¶ä»“ä½ï¼ˆâ‰¤20%ï¼‰
3. â„¹ï¸ è®¾ç½®æ­¢æŸæ­¢ç›ˆç‚¹ä½
4. â„¹ï¸ æ³¨æ„å¤§ç›˜å’Œè¡Œä¸šæ•´ä½“èµ°åŠ¿
5. â„¹ï¸ ç»“åˆè‡ªèº«é£é™©æ‰¿å—èƒ½åŠ›å†³ç­–

"""
        else:
            content += """
**å½“å‰é£é™©ç­‰çº§**: âœ… ä½é£é™©ï¼ˆç›¸å¯¹ï¼‰

**é£é™©æè¿°**:
- æ™ºèƒ½ä½“é«˜åº¦å…±è¯†ï¼ˆ>75%ï¼‰ï¼Œåˆ†æç»“æœè¾ƒä¸ºä¸€è‡´
- å¸‚åœºæ–¹å‘ç›¸å¯¹æ˜ç¡®ï¼Œä¿¡å·è¾ƒä¸ºå¯é 
- é€‚åˆå„ç±»é£é™©åå¥½çš„æŠ•èµ„è€…å‚è€ƒ

**é£é™©æç¤º**:
1. âœ… åˆ†æç»“æœç›¸å¯¹å¯é ï¼Œä½†ä»éœ€è°¨æ…
2. âœ… å»ºè®®ä»“ä½å¯é€‚å½“æé«˜ï¼ˆâ‰¤30%ï¼‰
3. âœ… ä»éœ€è®¾ç½®æ­¢æŸæ­¢ç›ˆä¿æŠ¤
4. âœ… æ³¨æ„å¸‚åœºçªå‘å˜åŒ–
5. âœ… æŠ•èµ„å†³ç­–éœ€è‡ªè¡Œåˆ¤æ–­

"""
        
        # æ·»åŠ é€šç”¨é£é™©æç¤º
        content += """
### é‡è¦é£é™©æç¤º

âš ï¸ **æŠ•èµ„æœ‰é£é™©ï¼Œå…¥å¸‚éœ€è°¨æ…**

1. **AIåˆ†æå±€é™**: æœ¬æŠ¥å‘Šç”±AIæ™ºèƒ½ä½“ç”Ÿæˆï¼Œå­˜åœ¨ç®—æ³•å±€é™æ€§å’Œæ•°æ®æ»åæ€§
2. **å¸‚åœºä¸å¯é¢„æµ‹**: è‚¡å¸‚å—å¤šç§å› ç´ å½±å“ï¼Œè¿‡å»è¡¨ç°ä¸ä»£è¡¨æœªæ¥æ”¶ç›Š
3. **ä¸æ„æˆå»ºè®®**: æœ¬æŠ¥å‘Šä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®æˆ–æ‰¿è¯º
4. **è‡ªè´Ÿç›ˆäº**: æŠ•èµ„å†³ç­–åŠå…¶åæœç”±æŠ•èµ„è€…è‡ªè¡Œæ‰¿æ‹…
5. **ä¸“ä¸šå’¨è¯¢**: é‡å¤§æŠ•èµ„å†³ç­–å»ºè®®å’¨è¯¢ä¸“ä¸šè´¢åŠ¡é¡¾é—®

âš ï¸ **ç‰¹åˆ«æé†’**:
- æœ¬æŠ¥å‘ŠåŸºäºå†å²æ•°æ®å’Œå½“å‰å¸‚åœºä¿¡æ¯ç”Ÿæˆ
- AIæ¨¡å‹å¯èƒ½å­˜åœ¨åå·®å’Œè¯¯åˆ¤
- å¸‚åœºæƒ…å†µéšæ—¶å¯èƒ½å‘ç”Ÿå˜åŒ–
- è¯·åŠ¡å¿…ç»“åˆå®æ—¶å¸‚åœºæƒ…å†µå’Œè‡ªèº«æƒ…å†µåšå‡ºå†³ç­–

"""
        
        return content + "\n---\n\n"
    
    def _generate_disclaimer(self) -> str:
        """ç”Ÿæˆå…è´£å£°æ˜"""
        
        return f"""
## ğŸ“‹ å…è´£å£°æ˜

æœ¬æŠ¥å‘Šç”±AIæ™ºèƒ½ä½“ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼ŒæŠ¥å‘Šä¸­çš„æ‰€æœ‰ä¿¡æ¯ã€åˆ†æå’Œå»ºè®®ä»…ä¾›å‚è€ƒã€‚

**é‡è¦å£°æ˜**:

1. **éæŠ•èµ„å»ºè®®**: æœ¬æŠ¥å‘Šä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€ä¹°å–æ¨èæˆ–æ“ä½œæŒ‡å¼•
2. **æ•°æ®å‡†ç¡®æ€§**: æŠ¥å‘ŠåŸºäºå…¬å¼€æ•°æ®å’ŒAIåˆ†æï¼Œæ•°æ®å‡†ç¡®æ€§å’Œæ—¶æ•ˆæ€§æ— æ³•å®Œå…¨ä¿è¯
3. **æŠ•èµ„é£é™©**: è‚¡ç¥¨æŠ•èµ„å­˜åœ¨é£é™©ï¼Œå¯èƒ½å¯¼è‡´æœ¬é‡‘æŸå¤±ï¼ŒæŠ•èµ„è€…éœ€å……åˆ†äº†è§£å¹¶æ‰¿æ‹…é£é™©
4. **ç‹¬ç«‹å†³ç­–**: æŠ•èµ„è€…åº”åŸºäºè‡ªèº«æƒ…å†µå’Œç‹¬ç«‹åˆ¤æ–­åšå‡ºæŠ•èµ„å†³ç­–
5. **ä¸“ä¸šå’¨è¯¢**: é‡å¤§æŠ•èµ„å†³ç­–å»ºè®®å’¨è¯¢ä¸“ä¸šæŒç‰ŒæŠ•èµ„é¡¾é—®
6. **è´£ä»»é™åˆ¶**: æŠ¥å‘Šç”Ÿæˆè€…å¯¹å› ä½¿ç”¨æœ¬æŠ¥å‘Šè€Œäº§ç”Ÿçš„ä»»ä½•ç›´æ¥æˆ–é—´æ¥æŸå¤±ä¸æ‰¿æ‹…è´£ä»»

**ä½¿ç”¨æ¡æ¬¾**:

ä½¿ç”¨æœ¬æŠ¥å‘Šå³è¡¨ç¤ºæ‚¨å·²é˜…è¯»ã€ç†è§£å¹¶åŒæ„ä¸Šè¿°å…è´£å£°æ˜ã€‚

---

*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: {self.timestamp}*  
*æŠ€æœ¯æ”¯æŒ: éº’éºŸé‡åŒ–äº¤æ˜“å¹³å° - TradingAgentså¤šæ™ºèƒ½ä½“ç³»ç»Ÿ*  
*ç‰ˆæœ¬: Enhanced v1.0*

"""


def create_enhanced_report(symbol: str, result: Dict[str, Any], depth: str = "æ ‡å‡†") -> str:
    """
    åˆ›å»ºå¢å¼ºç‰ˆåˆ†ææŠ¥å‘Šçš„ä¾¿æ·å‡½æ•°
    
    Args:
        symbol: è‚¡ç¥¨ä»£ç 
        result: åˆ†æç»“æœ
        depth: åˆ†ææ·±åº¦
        
    Returns:
        å®Œæ•´çš„Markdownæ ¼å¼æŠ¥å‘Š
    """
    generator = EnhancedReportGenerator()
    return generator.generate_full_report(symbol, result, depth)
