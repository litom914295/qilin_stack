# 🎯 竞价进阶数据流说明

> 竞价进阶如何与竞价决策形成闭环

---

## 🔄 完整工作流

### 推荐流程（闭环）

```
第1步：T日候选筛选
  ├─ 导航到：🎯 竞价决策 > 📊 T日候选筛选
  ├─ 设置筛选条件
  ├─ 点击「🔍 执行筛选」
  └─ 生成候选股票列表 ✅
      ↓
第2步：竞价进阶优化
  ├─ 导航到：🎯 竞价决策 > 🎯 竞价进阶
  ├─ 切换到「📊 数据准备」
  ├─ 选择「🎯 使用竞价决策数据」← 自动获取！
  └─ 数据已准备就绪 ✅
      ↓
第3步：运行优化
  ├─ 切换到「📈 运行Pipeline」
  ├─ 选择运行模式
  └─ 点击「🚀 运行完整Pipeline」
      ↓
第4步：查看结果
  └─ 切换到「📋 查看结果」查看优化效果
```

---

## 📊 三种数据来源

### 1. 🎯 使用竞价决策数据（推荐）

**优势**：
- ✅ 无需手动准备数据
- ✅ 自动与竞价决策联动
- ✅ 数据格式完全兼容
- ✅ 形成完整工作流闭环

**步骤**：
1. 先在「T日候选筛选」执行筛选
2. 切换到「竞价进阶 > 数据准备」
3. 选择「🎯 使用竞价决策数据」
4. 系统自动加载并处理数据

### 2. 🎲 生成演示数据

**适用场景**：
- 快速体验竞价进阶功能
- 测试Pipeline运行
- 学习使用方法

**特点**：
- 可自定义样本数量和特征数量
- 数据格式符合要求
- 适合新手练习

### 3. 📄 上传CSV数据

**适用场景**：
- 使用外部数据源
- 已有准备好的特征数据
- 需要测试特定数据集

**数据要求**：
- 必需列：`date`、`target`
- 推荐列：`symbol`
- 其他列：任意特征（建议30-150个）

---

## 🔗 数据流转细节

### 从竞价决策到竞价进阶

**数据传递**：
```python
# 竞价决策保存数据
st.session_state['t_day_candidates'] = candidates_df

# 竞价进阶读取数据
candidates_df = st.session_state.get('t_day_candidates')
```

**数据处理**：
1. **添加date列**：如果缺失，使用当前日期
2. **添加target列**：
   - 优先使用 `prediction_score` 作为目标变量
   - 如果不存在，生成模拟目标值
3. **提取特征列**：排除 `date`、`symbol`、`name`、`target`

**验证检查**：
- ✅ 确保有date列
- ✅ 确保有target列
- ✅ 统计特征数量

---

## 💡 最佳实践

### 推荐工作流

1. **每日盘后**（15:30）
   - 在「T日候选筛选」执行筛选
   - 筛选出20-30只候选股票

2. **数据优化**（15:35）
   - 切换到「竞价进阶」
   - 使用竞价决策数据
   - 运行完整Pipeline

3. **结果应用**（15:40）
   - 查看优化后的特征集
   - 分析因子健康状况
   - 验证模型性能
   - 导出结果用于次日决策

### 常见场景

#### 场景1：日常使用
```
T日候选筛选 → 竞价进阶优化 → 查看结果 → 应用于T+1决策
```

#### 场景2：快速测试
```
竞价进阶 → 生成演示数据 → 运行Pipeline → 查看效果
```

#### 场景3：离线研究
```
准备CSV数据 → 竞价进阶 → 上传数据 → 完整分析
```

---

## 🎯 关键改进

### 改进前（问题）
❌ 需要手动准备CSV文件  
❌ 数据格式容易出错  
❌ 工作流不连贯  
❌ 需要在不同工具间切换  

### 改进后（解决）
✅ 自动从竞价决策获取数据  
✅ 数据格式自动处理  
✅ 完整工作流闭环  
✅ 一个界面完成所有操作  

---

## 📈 数据状态提示

竞价进阶会实时显示数据状态：

- ✅ **已加载数据**：显示数据来源（竞价决策/演示数据/CSV）
- 🎯 **检测到竞价决策数据**：提示可以直接使用
- ⚠️ **未检测到数据**：提醒先准备数据

---

## ❓ 常见问题

### Q: 如果没有执行T日筛选怎么办？

**A**: 竞价进阶会提示：
```
ℹ️ 未检测到竞价决策数据。
   请先在「T日候选筛选」执行筛选，或上传/生成数据。
```

### Q: 竞价决策的数据格式合适吗？

**A**: 完全合适！竞价进阶会自动：
- 添加缺失的必需列
- 使用 `prediction_score` 作为 `target`
- 提取所有可用特征

### Q: 可以同时使用多个数据源吗？

**A**: 可以切换，但每次只能使用一个：
- 选择「使用竞价决策数据」会覆盖之前的数据
- 选择「生成演示数据」也会覆盖
- 上传CSV同样会覆盖

### Q: 数据会保存吗？

**A**: 
- 在同一个会话中，数据保存在 `st.session_state`
- 刷新浏览器会丢失
- 可以在「查看结果」导出处理后的结果

---

## 🚀 快速开始

```bash
# 第1步：启动应用
streamlit run web/unified_dashboard.py

# 第2步：导航
🎯 竞价决策 → 📊 T日候选筛选

# 第3步：筛选候选股
设置条件 → 执行筛选

# 第4步：切换到竞价进阶
🎯 竞价决策 → 🎯 竞价进阶

# 第5步：使用数据
📊 数据准备 → 🎯 使用竞价决策数据

# 第6步：运行优化
📈 运行Pipeline → 🚀 运行完整Pipeline
```

---

**就这么简单！工作流已经完全打通！** 🎉
