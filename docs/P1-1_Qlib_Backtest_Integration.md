# P1-1: Qlib原生回测执行器UI集成

## 📋 任务概述

将Qlib原生回测执行器完整集成到麒麟项目Web UI的"投资组合 → 回测"标签页，使用户能够通过UI界面完成完整的Qlib回测流程，无需命令行操作。

## ✅ 完成内容

### 1. 创建独立回测模块
**文件**: `web/tabs/qlib_backtest_tab.py`

提供完整的Qlib回测功能界面，包括：

#### 1.1 回测配置页面 📋
- **预测信号源**：
  - 从MLflow实验加载
  - 从本地文件上传（CSV/PKL）
  - 使用示例数据（快速演示）
  
- **回测参数**：
  - 时间范围配置
  - 基准指数选择（沪深300、中证500等）
  - 初始资金设置
  
- **策略参数**：
  - 持仓股票数量（topk）
  - 每次卖出数量（n_drop）
  
- **交易成本**：
  - 买入/卖出手续费
  - 最低手续费

#### 1.2 回测结果页面 📊
- **关键绩效指标卡片**：
  - 年化收益率
  - 夏普比率
  - 最大回撤
  - 胜率
  
- **可视化图表**：
  - 净值曲线（策略 vs 基准）
  - 回撤分析图
  - 收益分布直方图
  
- **详细指标表格**：
  - 累计收益率
  - 波动率
  - 其他风险指标
  
- **交易记录**：
  - 显示前100条交易
  - 支持下载完整CSV

#### 1.3 风险分析页面 📈
- **VaR/CVaR分析**：
  - 可调置信水平
  - 下行风险指标
  
- **滚动风险指标**：
  - 可调窗口大小（20/40/60/120/250天）
  - 滚动波动率
  - 滚动夏普比率
  
- **月度收益热力图**：
  - 按年月展示收益率
  - 红绿配色直观展示

### 2. 集成到主界面
**修改文件**: `web/unified_dashboard.py`

在 `render_qlib_portfolio_tab()` 方法中：
- 保留原有的引擎选择开关
- 当选择"Qlib原生(推荐)"时，调用新的回测模块
- 当选择"写实回测(自研)"时，保留原有逻辑
- 异常处理和用户友好的错误提示

### 3. 核心功能实现

#### 3.1 Qlib初始化检查
```python
def _ensure_qlib_initialized():
    """确保Qlib已经初始化"""
    # 检查provider_uri配置
    # 提供默认路径
    # 支持快速初始化
```

#### 3.2 回测执行函数
```python
def run_qlib_backtest(...):
    """运行Qlib回测并返回结构化结果"""
    # 配置Strategy（TopkDropoutStrategy）
    # 配置Executor（SimulatorExecutor）
    # 配置Exchange（交易成本、涨跌停等）
    # 运行backtest并计算指标
    # 返回标准化结果字典
```

#### 3.3 数据流设计
- **输入**：预测分数（MultiIndex: datetime × instrument）
- **处理**：通过Qlib的backtest函数执行
- **输出**：
  - 净值序列
  - 日收益率序列
  - 回撤序列
  - 聚合指标字典
  - 交易记录

#### 3.4 与现有系统集成
- **session_state共享**：
  - `st.session_state['backtest_results']`: 完整回测结果
  - `st.session_state['last_backtest_returns']`: 日收益率序列
  
- **下游模块使用**：
  - 风险控制页面可直接读取 `last_backtest_returns`
  - 实验管理页面可关联MLflow记录

## 🎯 技术要点

### 与Qlib对齐
- 使用Qlib标准的 `backtest()` 函数
- 配置遵循Qlib的 `init_instance_by_config` 模式
- 策略采用 `TopkDropoutStrategy`（Qlib内置）
- 执行器采用 `SimulatorExecutor`（Qlib标准）

### 用户友好设计
- 支持多种预测数据来源
- 提供示例数据快速体验
- 清晰的参数说明和帮助提示
- 完善的错误处理和追踪

### 可扩展性
- 模块化设计，易于添加新功能
- 配置与执行分离
- 结果标准化，便于对接其他模块

## 📊 使用流程

### 基本流程
```
1. 进入"投资组合 → 回测"页面
2. 选择"Qlib原生(推荐)"引擎
3. 在"回测配置"标签：
   - 选择或上传预测信号
   - 设置回测参数
   - 点击"🚀 运行回测"
4. 在"回测结果"标签查看：
   - 关键指标
   - 净值曲线
   - 交易记录
5. 在"风险分析"标签查看：
   - VaR/CVaR
   - 滚动指标
   - 月度收益
```

### 示例数据快速演示
```
1. 选择"使用示例数据"
2. 点击"生成示例数据"
3. 其他参数使用默认值
4. 点击"🚀 运行回测"
5. 查看结果
```

### 从实验加载
```
1. 选择"从实验加载"
2. 输入实验名称和Recorder ID
3. 输入预测文件名（通常是pred.pkl）
4. 点击"加载预测结果"
5. 配置其他参数
6. 运行回测
```

## 🔗 与其他模块的联动

### 1. 模型训练 → 回测
- 在"模型训练"页面训练模型并生成预测
- 预测结果自动保存到MLflow
- 在回测页面从实验加载预测
- 执行回测评估模型效果

### 2. 回测 → 风险控制
- 回测完成后自动保存 `last_backtest_returns`
- 风险控制页面检测到新的回测结果
- 可选择"回测(最近一次)"进行风险分析
- 计算VaR、CVaR等风险指标

### 3. 回测 → 实验管理
- 回测结果可关联到MLflow实验
- 记录回测参数和指标
- 便于对比不同配置的效果

## 🚀 后续优化方向

### P1-2: 更多策略支持
- 集成更多Qlib内置策略
- 支持自定义策略上传
- 策略参数可视化配置

### P1-3: 高频数据支持
- 分钟级回测
- tick级回测
- 高频因子支持

### P1-4: 更强大的分析
- 归因分析集成
- 多策略对比
- 交易成本详细分析

### P1-5: 性能优化
- 大规模股票池支持
- 长周期回测加速
- 并行回测

## 📝 代码质量

- ✅ 完整的类型注解
- ✅ 详细的docstring
- ✅ 异常处理和日志
- ✅ 模块化设计
- ✅ 遵循Qlib最佳实践
- ✅ UI/UX友好

## 🎉 总结

P1-1任务已完成，实现了Qlib原生回测执行器的完整UI集成。用户现在可以：

1. ✅ 通过Web UI完成完整的Qlib回测流程
2. ✅ 可视化查看详细的回测结果和风险指标
3. ✅ 与模型训练、风险管理等模块无缝联动
4. ✅ 支持多种数据源和灵活配置
5. ✅ 获得与Qlib命令行一致的回测体验

**下一步**: 准备开始P1-2任务 - 集成qrun YAML工作流UI界面。
