# 智能选股与历史训练管道整合指南

## 🎯 两个功能的完美整合

### 整合前后对比

**整合前**：
- 智能选股 → 生成候选 ✅
- 历史训练管道 → 使用全市场 ✅
- **问题**：两个功能各自独立，无法协同

**整合后**：
- 智能选股 → 生成候选 ✅
- **新增**：智能选股的股票池 → 直接用于历史训练管道 🎯
- **新增**：历史训练管道支持两种模式（全市场 OR 选中的股票池）⚡

## 🔄 完整工作流程

```
Step 1: 智能选股
    ├─ 手动选择：测试用
    └─ 智能选择：自动获取今日涨停板 ✅
         ↓
         获得30只涨停板股票
         ↓
Step 2: 快速训练（可选）
    ├─ 构建数据集（AKShare获取历史数据）
    ├─ 训练模型（Stacking）
    └─ 生成T+1候选
         ↓
Step 3: 历史训练管道（新整合功能）★
    ├─ 模式选择：
    │   ├─ 使用全市场股票（完整研究）
    │   └─ 使用上方选中的股票池（快速训练）★★★
    │       ↓
    │       复用Step1的30只股票
    │       ↓
    ├─ 完整特征工程
    ├─ LightGBM训练
    ├─ SHAP特征重要性分析
    └─ 生成智能体权重建议
         ↓
Step 4: 应用到实盘
    └─ 使用优化的智能体权重进行交易
```

## 💡 核心价值

### 1. **股票池复用** 🔄

**之前**：
- 智能选股得到30只涨停板
- 历史训练管道重新扫描全市场3000+只
- **浪费资源，耗时长**

**现在**：
- 智能选股得到30只涨停板
- 历史训练管道直接使用这30只 ✅
- **节省时间，针对性强**

### 2. **两种模式灵活切换** 🎯

| 场景 | 推荐模式 | 耗时 | 股票数 |
|------|---------|------|--------|
| 每日交易 | 智能选股 + 快速训练 | 15分钟 | 20-30只 |
| 周末研究 | 智能选股 + 股票池模式管道 | 30分钟 | 30-50只 |
| 季度优化 | 全市场模式管道 | 2小时 | 3000+只 |
| 论文研究 | 全市场模式管道 | 3小时 | 全量 |

### 3. **完整的研究链路** 📊

```
涨停板数据 → 快速验证 → 深度分析 → 权重优化 → 实盘应用
    ↑          ↑          ↑          ↑          ↑
智能选股   快速训练  历史管道  智能体权重  交易系统
```

## 🚀 实战示例

### 场景1：每日早晨（09:30-10:00）

```markdown
目标：生成今日T+1交易候选

1. 打开 Qlib → 模型训练 → 一进二策略
2. 选择"🤖 智能选择（自动获取今日涨停板）"
3. 等待自动获取（显示：今日有 45 只涨停板）
4. 设置"限制数量"为 30
5. 选择"📡 AKShare在线模式"
6. 点击"📦 构建数据集"（等待10分钟）
7. 点击"🧠 训练模型"（等待3分钟）
8. 点击"🎯 生成T+1候选"
9. ✅ 得到明日重点关注的5-10只股票

耗时：15-20分钟
不运行历史训练管道（留到周末）
```

### 场景2：周六下午（深度研究）

```markdown
目标：优化智能体权重，提升系统整体表现

===== 第一部分：智能选股 =====
1. 选择"🤖 智能选择"
2. 点击"🔄 刷新涨停板"获取周五数据
3. 假设获得 80 只涨停板
4. 设置"限制数量"为 50
5. 点击"📦 构建数据集"（等待15分钟）

===== 第二部分：历史训练管道（关键）=====
6. 向下滚动到"🧪 历史训练管道"部分
7. **重点**：选择"🎯 使用上方选中的股票池"
8. 看到提示：✅ 将使用上方选中的 50 只股票进行训练
9. 设置时间范围：
   - 开始：2024-01-01
   - 结束：2025-10-29
10. 勾选"✅ 训练后写入建议权重到配置文件"
11. 点击"🚀 运行研究训练管道"
12. 等待30-60分钟

===== 查看结果 =====
13. 训练完成后，查看：
    - AUC: 0.72（很好）
    - AP: 0.68（不错）
    - 智能体权重建议（已自动应用）
14. ✅ 下周一使用新权重进行交易

耗时：1.5-2小时
效果：系统预测准确率提升
```

### 场景3：季度优化（完整研究）

```markdown
目标：全市场分析，发现最优特征组合

1. 不使用智能选股（跳过上方部分）
2. 直接到"历史训练管道"
3. 选择"👉 使用全市场股票（完整研究）"
4. 设置时间范围：最近1年
5. 勾选"写入建议权重"
6. 点击"运行研究训练管道"
7. 等待2-3小时
8. ✅ 得到基于全市场的权重建议

耗时：2-3小时
适用：季度末策略优化
```

## 📊 技术细节

### 股票代码格式转换

系统自动处理不同格式：

```python
# 智能选股格式（AKShare）
000001.SZ, 600519.SH

# 历史管道格式（Qlib）
SZ000001, SH600519

# 自动转换逻辑
"000001.SZ" → "SZ000001"
"600519.SH" → "SH600519"
```

### 数据流向

```
智能选股
    ↓
symbols = ["000001.SZ", "600519.SH", ...]
    ↓
st.session_state['limitup_stocks'] = symbols
    ↓
历史训练管道检测到"股票池模式"
    ↓
converted = ["SZ000001", "SH600519", ...]
    ↓
fetch_panel(converted, start, end)
    ↓
训练 & 分析
    ↓
生成智能体权重
```

## ⚙️ 配置说明

### 智能体权重映射

| 特征 | 智能体 | 说明 |
|------|--------|------|
| close_to_high | seal_quality | 封单质量 |
| vol_ratio | volume_surge | 量能爆发 |
| cont_limit | board_continuity | 连板能力 |
| ret_5 | qlib_momentum | 动量因子 |
| ma5_cross_up | technical_analyst | 技术形态 |
| amp | pattern | 振幅/波动 |
| turnover | risk | 流动性风险 |

### 输出文件

所有输出保存在 `output/limitup_research/`：

```
output/limitup_research/
├── limitup_samples_2024-01-01_2025-10-29_custom.parquet  # 数据集
├── limitup_model_1234567890.pkl                          # 模型
├── feature_importance_shap.csv                           # SHAP分析
├── feature_importance_permutation.csv                    # Permutation分析
├── agent_weight_suggestions.json                         # 权重建议
└── training_summary_2024-01-01_2025-10-29_custom.json   # 训练摘要
```

## 🎯 最佳实践建议

### DO ✅

1. **每天早上**：用智能选股生成候选
2. **每周末**：用股票池模式运行历史管道
3. **每月**：用全市场模式运行完整研究
4. **先验证后应用**：先看AUC/AP，再决定是否应用权重

### DON'T ❌

1. ❌ 不要在交易时段运行历史管道
2. ❌ 不要频繁修改智能体权重（保持稳定）
3. ❌ 不要忽略训练结果（AUC<0.6说明模型无效）
4. ❌ 不要在未选择股票时使用股票池模式

## 🔍 FAQ

### Q1: 什么时候用"股票池模式"？

**A**: 当你想快速验证上方选中的特定股票时。比如：
- 本周涨停板的深度分析
- 特定板块的研究
- 快速测试新想法

### Q2: 什么时候用"全市场模式"？

**A**: 当你需要完整、全面的分析时。比如：
- 初次部署系统
- 季度/年度优化
- 学术研究

### Q3: 两种模式的结果有什么区别？

**A**:
- **股票池模式**：权重针对特定股票（如涨停板特征）
- **全市场模式**：权重更通用，适用于所有股票

### Q4: 可以同时运行两种模式吗？

**A**: 可以，但不建议。建议：
1. 先用股票池模式快速验证
2. 效果好再用全市场模式深度研究

## 📚 相关文档

- [股票池选择指南](STOCK_POOL_GUIDE.md) - 详细的选股说明
- [AKShare使用指南](AKSHARE_GUIDE.md) - 数据源配置
- [一进二策略说明](ONE_INTO_TWO_STRATEGY.md) - 策略原理
