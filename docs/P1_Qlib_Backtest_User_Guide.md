# Qlib原生回测功能使用指南

## 📚 目录
1. [快速开始](#快速开始)
2. [功能介绍](#功能介绍)
3. [详细使用](#详细使用)
4. [常见问题](#常见问题)
5. [技术细节](#技术细节)

## 🚀 快速开始

### 前置条件
1. **安装Qlib**
   ```bash
   pip install pyqlib
   ```

2. **初始化Qlib数据**（首次使用）
   ```python
   import qlib
   from qlib.constant import REG_CN
   
   # 初始化
   qlib.init(provider_uri="~/.qlib/qlib_data/cn_data", region=REG_CN)
   
   # 下载数据（首次）
   python -m qlib.run.get_data qlib_data --target_dir ~/.qlib/qlib_data/cn_data --region cn
   ```

### 5分钟快速体验

1. **启动Web界面**
   ```bash
   cd G:/test/qilin_stack
   streamlit run web/unified_dashboard.py
   ```

2. **进入回测页面**
   - 点击顶部"Qlib量化平台"标签
   - 选择"💼 投资组合"
   - 选择"⏪ 回测"子标签
   - 确保选择"Qlib原生(推荐)"引擎

3. **使用示例数据运行回测**
   - 在"📋 回测配置"标签中
   - 预测信号源选择"使用示例数据"
   - 点击"生成示例数据"按钮
   - 其他参数保持默认
   - 点击"🚀 运行回测"
   - 等待几秒钟...

4. **查看结果**
   - 切换到"📊 回测结果"标签
   - 查看关键指标、净值曲线、交易记录
   - 切换到"📈 风险分析"标签
   - 查看VaR/CVaR、滚动指标、月度收益

🎉 恭喜！您已成功运行了第一个Qlib回测！

## 📖 功能介绍

### 1. 回测配置 📋

#### 1.1 预测信号源
提供三种方式输入预测信号：

**方式一：从实验加载**（推荐用于生产）
- 从MLflow实验中加载已训练模型的预测结果
- 支持通过实验名称或Recorder ID定位
- 适用于模型训练后的回测验证

**方式二：从文件上传**
- 支持CSV或PKL格式
- CSV要求：datetime索引 + instrument列 + score列
- 适用于外部预测数据导入

**方式三：使用示例数据**（推荐用于学习）
- 一键生成模拟数据
- 快速体验回测功能
- 无需准备真实数据

#### 1.2 回测参数
- **时间范围**：选择回测的开始和结束日期
- **基准指数**：
  - SH000300：沪深300（默认）
  - SH000905：中证500
  - SH000852：中证1000
  - SZ399006：创业板指

#### 1.3 策略参数
- **持仓股票数量（topk）**：每次调仓时持有的股票数量（默认30）
- **每次卖出数量（n_drop）**：每次调仓时强制卖出的股票数量（默认5）

#### 1.4 交易成本
- **买入手续费**：默认0.15%
- **卖出手续费**：默认0.25%（含印花税）
- **最低手续费**：默认5元

### 2. 回测结果 📊

#### 2.1 关键绩效指标
四个核心指标卡片显示：
- **年化收益率**：策略的年化投资回报
- **夏普比率**：风险调整后的收益
- **最大回撤**：历史最大损失幅度
- **胜率**：盈利交易日占比

#### 2.2 净值曲线
- 蓝色实线：策略净值走势
- 橙色虚线：基准指数走势
- 支持交互式缩放和详细查看

#### 2.3 回撤分析
- 红色填充区域显示回撤深度
- 可识别最大回撤发生时间
- 帮助评估风险承受能力

#### 2.4 收益分布
- 直方图展示日收益率分布
- 判断收益分布是否正态
- 识别异常收益日

#### 2.5 交易记录
- 显示前100条交易详情
- 支持下载完整CSV文件
- 包含时间、股票、价格、数量等信息

### 3. 风险分析 📈

#### 3.1 VaR/CVaR分析
- **VaR（在险价值）**：
  - 在给定置信水平下的最大可能损失
  - 可调置信水平（90%-99%）
  - 默认95%

- **CVaR（条件在险价值）**：
  - 超过VaR时的平均损失
  - 尾部风险度量

- **下行风险**：
  - 仅考虑负收益的波动率
  - 更关注下行风险

#### 3.2 滚动风险指标
- **滚动波动率**：
  - 动态显示风险变化
  - 支持多种窗口大小（20/40/60/120/250天）
  
- **滚动夏普比率**：
  - 时变的风险调整收益
  - 识别策略表现周期

#### 3.3 月度收益热力图
- 按年月展示收益率
- 红色表示亏损，绿色表示盈利
- 快速识别季节性模式

## 📝 详细使用

### 场景一：评估已训练模型

**步骤**：
1. 在"模型训练"页面训练模型
2. 确保预测结果已保存到MLflow
3. 进入"回测"页面
4. 选择"从实验加载"
5. 输入实验名称（如"qlib_models"）
6. 可选：输入Recorder ID精确定位
7. 输入预测文件名（通常是"pred.pkl"）
8. 点击"加载预测结果"
9. 配置回测参数
10. 运行回测并查看结果

**提示**：
- 记录Recorder ID便于后续追溯
- 可以对同一模型尝试不同的回测参数
- 建议先用短时间范围测试

### 场景二：上传外部预测

**CSV格式要求**：
```csv
datetime,instrument,score
2020-01-02,000001.SZ,0.234
2020-01-02,000002.SZ,-0.156
2020-01-03,000001.SZ,0.412
...
```

**PKL格式要求**：
- pandas Series
- MultiIndex: (datetime, instrument)
- 值为预测分数

**步骤**：
1. 准备符合格式的预测文件
2. 选择"从文件上传"
3. 点击上传按钮选择文件
4. 系统自动验证格式
5. 配置回测参数
6. 运行回测

### 场景三：参数调优

**目标**：找到最优的topk和n_drop组合

**方法**：
1. 使用相同的预测数据
2. 尝试不同的topk值（如20, 30, 40, 50）
3. 尝试不同的n_drop值（如0, 5, 10）
4. 记录每组参数的关键指标
5. 对比选择最优组合

**建议组合**：
- 稳健型：topk=50, n_drop=5
- 平衡型：topk=30, n_drop=5（默认）
- 激进型：topk=20, n_drop=10

### 场景四：风险管理联动

**流程**：
1. 在回测页面运行回测
2. 系统自动保存 `last_backtest_returns`
3. 进入"风险控制"页面
4. 数据源选择"回测(最近一次)"
5. 查看详细风险指标
6. 设置风险预警阈值

## ❓ 常见问题

### Q1: 提示"Qlib未初始化"怎么办？
**A**: 
1. 确认已安装Qlib：`pip install pyqlib`
2. 点击页面上的"快速初始化Qlib"展开器
3. 输入数据路径或使用默认路径
4. 点击"初始化Qlib"按钮
5. 如果仍失败，需要先下载数据（见快速开始部分）

### Q2: 回测运行很慢怎么办？
**A**: 
- 缩短回测时间范围
- 减少持仓股票数量
- 使用更短的数据频率
- 检查服务器资源占用

### Q3: 净值曲线不显示基准怎么办？
**A**: 
- 确认基准指数数据存在
- 检查Qlib数据是否完整
- 尝试切换其他基准指数

### Q4: 交易记录为空？
**A**: 
- 检查预测数据是否有效
- 确认topk参数不为0
- 查看详细错误日志

### Q5: 如何保存回测配置？
**A**: 
- 点击"💾 保存配置"按钮
- 配置保存在session_state中
- 页面刷新后需重新配置

### Q6: 可以导出回测报告吗？
**A**: 
当前支持：
- ✅ 下载交易记录CSV
- ⏳ 完整PDF报告（规划中）
- ⏳ Excel报告（规划中）

### Q7: 支持分钟级回测吗？
**A**: 
- 当前版本仅支持日级回测
- 分钟级回测在P1-3阶段开发
- 需要下载相应频率的数据

## 🔧 技术细节

### 数据格式

**预测分数格式**：
```python
# pandas Series with MultiIndex
pred_score = pd.Series(
    data=[0.234, -0.156, 0.412, ...],
    index=pd.MultiIndex.from_tuples([
        (datetime(2020,1,2), '000001.SZ'),
        (datetime(2020,1,2), '000002.SZ'),
        (datetime(2020,1,3), '000001.SZ'),
        ...
    ], names=['datetime', 'instrument'])
)
```

**回测结果格式**：
```python
results = {
    'portfolio_value': pd.Series,      # 净值序列
    'benchmark_value': pd.Series,      # 基准净值
    'daily_returns': pd.Series,        # 日收益率
    'drawdown': pd.Series,             # 回撤序列
    'metrics': {
        'annualized_return': float,
        'cumulative_return': float,
        'information_ratio': float,
        'max_drawdown': float,
        'volatility': float,
        'win_rate': float,
    },
    'trades': pd.DataFrame,            # 交易记录
    'raw_portfolio': pd.DataFrame,     # 原始组合数据
}
```

### Qlib配置

**策略配置**：
```python
strategy_config = {
    "class": "TopkDropoutStrategy",
    "module_path": "qlib.contrib.strategy.signal_strategy",
    "kwargs": {
        "signal": pred_score,      # 预测信号
        "topk": 30,                # 持仓数量
        "n_drop": 5,               # 卖出数量
    },
}
```

**执行器配置**：
```python
executor_config = {
    "class": "SimulatorExecutor",
    "module_path": "qlib.backtest.executor",
    "kwargs": {
        "time_per_step": "day",              # 调仓频率
        "generate_portfolio_metrics": True,  # 生成组合指标
    },
}
```

**交易所配置**：
```python
exchange_kwargs = {
    "freq": "day",              # 数据频率
    "start_time": "2020-01-01",
    "end_time": "2020-12-31",
    "codes": "all",             # 股票池
    "open_cost": 0.0015,        # 买入成本
    "close_cost": 0.0025,       # 卖出成本
    "min_cost": 5.0,            # 最低成本
}
```

### 性能优化建议

1. **合理设置时间范围**
   - 测试：1-3个月
   - 验证：1年
   - 生产：2-3年

2. **控制股票池大小**
   - 小规模：topk=10-20
   - 中等规模：topk=30-50
   - 大规模：topk=100+

3. **调整调仓频率**
   - 日度调仓：适合高频策略
   - 周度调仓：适合中频策略
   - 月度调仓：适合低频策略

## 📞 技术支持

遇到问题？
1. 查看本文档的常见问题部分
2. 检查错误日志（点击"查看详细错误"）
3. 查阅Qlib官方文档：https://qlib.readthedocs.io/
4. 提交Issue到项目仓库

## 🎯 下一步

完成回测后，您可以：
1. ✅ 前往"风险控制"页面进行风险分析
2. ✅ 前往"实验管理"页面记录回测结果
3. ✅ 调整参数进行多次回测对比
4. ⏳ 使用qrun工作流自动化（P1-2开发中）
5. ⏳ 进行策略组合优化（规划中）

---

**祝您使用愉快！** 🚀
