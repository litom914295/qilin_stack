# 🧪 Qilin Stack 测试套件使用指南

**版本**: v1.0  
**日期**: 2025-11-07  
**作者**: Qilin Stack Team

---

## 📋 目录

1. [测试套件概览](#测试套件概览)
2. [快速开始](#快速开始)
3. [实盘小规模测试](#实盘小规模测试)
4. [性能压力测试](#性能压力测试)
5. [测试报告](#测试报告)
6. [常见问题](#常见问题)

---

## 测试套件概览

Qilin Stack测试套件包含两大类测试:

### 1️⃣ 实盘小规模测试 (`live_trading_test.py`)

**测试目标**: 验证实盘交易系统的功能正确性

**包含测试**:
- ✅ 基础订单执行 (买入/卖出)
- ✅ 多标的交易
- ✅ 风控机制验证
- ✅ 持仓跟踪
- ✅ 系统延迟测量

**支持券商**:
- **Mock** (模拟券商,推荐用于测试)
- **Ptrade** (迅投,需要真实账号)
- **QMT** (迅投Mini,需要真实账号)

### 2️⃣ 性能压力测试 (`performance_stress_test.py`)

**测试目标**: 验证系统在高负载下的稳定性和性能

**包含测试**:
- ✅ 100并发订单压力测试
- ✅ 长时间稳定性测试 (默认2分钟)
- ✅ 内存泄漏检测
- ✅ 异常恢复测试
- ✅ 因子计算性能测试

**性能指标**:
- 订单吞吐量 (订单/秒)
- 平均延迟 (毫秒)
- 内存增长率 (MB/秒)
- 错误率 (%)

---

## 快速开始

### 🚀 一键运行所有测试

**推荐方式** - 使用集成脚本:

```bash
python run_all_tests.py
```

这个脚本会:
1. ✅ 运行实盘交易测试 (使用Mock券商)
2. ✅ 运行性能压力测试
3. ✅ 自动生成测试报告
4. ✅ 显示测试摘要

**预期输出**:
```
================================================================================
🧪 Qilin Stack 集成测试套件
================================================================================
开始时间: 2025-11-07 14:30:00

================================================================================
🔄 步骤 1/3: 运行实盘交易测试
================================================================================
...

================================================================================
📊 最终测试摘要
================================================================================
总测试数: 10
通过: 10
成功率: 100.0%
总耗时: 45.2秒

✅ 测试状态: 优秀 - 系统稳定可靠!
📄 完整测试报告: test_report_20251107_143045.md
```

---

## 实盘小规模测试

### 📝 单独运行实盘测试

```bash
python tests/live_trading_test.py
```

### 交互式选择券商

运行后会提示选择券商:

```
请选择测试券商:
1. Mock (模拟券商,推荐)
2. Ptrade (迅投,需要真实账号)
3. QMT (迅投Mini,需要真实账号)

输入选择 [1/2/3] (默认=1):
```

### 使用Mock券商 (推荐)

**优点**:
- ✅ 无需真实账号
- ✅ 无需券商客户端
- ✅ 完全离线测试
- ✅ 100%可复现

**配置**:
```python
broker_config = {
    'initial_cash': 1000000,      # 100万初始资金
    'commission_rate': 0.0003     # 万三佣金
}
```

### 使用Ptrade/QMT券商

**⚠️ 注意事项**:
1. 需要安装迅投客户端
2. 需要真实账号信息
3. **强烈建议使用模拟盘账号**
4. 不要使用实盘账号进行测试

**配置** (需要修改):
```python
# Ptrade配置
broker_config = {
    'client_path': r'D:\ptrade\userdata_mini',
    'account_id': 'YOUR_ACCOUNT_ID',  # 替换为你的账号
    'session_id': None
}

# QMT配置
broker_config = {
    'client_path': r'D:\qmt\userdata_mini',
    'account_id': 'YOUR_ACCOUNT_ID',  # 替换为你的账号
    'session_id': None
}
```

### 测试结果

测试完成后会生成JSON结果文件:
```
live_trading_test_results_mock_20251107_143000.json
```

包含:
- 所有测试用例的详细结果
- 性能指标 (延迟、成功率)
- 错误信息 (如果有)

---

## 性能压力测试

### 📝 单独运行压力测试

```bash
python tests/performance_stress_test.py
```

### 测试项目详解

#### 1️⃣ 并发订单压力测试

**测试内容**: 同时发送100个订单

**验证指标**:
- 成功率 ≥ 95%
- 平均延迟 < 500ms

**示例输出**:
```
✅ 并发测试完成:
  成功订单: 100/100
  成功率: 100.0%
  总耗时: 2.34秒
  吞吐量: 42.7 订单/秒
  平均延迟: 23.40ms
  内存增长: 5.21MB
```

#### 2️⃣ 长时间稳定性测试

**测试内容**: 持续运行2分钟,每10秒采样

**验证指标**:
- 错误率 < 5%
- 内存增长率 < 0.1MB/秒

**示例输出**:
```
✅ 稳定性测试完成:
  总订单数: 300
  错误数: 0
  错误率: 0.00%
  内存增长: 8.52MB
  内存增长率: 0.0710MB/秒
```

#### 3️⃣ 内存泄漏检测

**测试内容**: 10轮迭代,每轮50个订单

**验证指标**:
- 平均内存增长 < 5MB/轮

**示例输出**:
```
📊 内存泄漏分析:
  平均增长: 2.34MB/轮
  标准差: 0.87MB
  最大增长: 3.21MB
  总增长: 23.40MB
  
✅ 未检测到显著内存泄漏
```

#### 4️⃣ 异常恢复测试

**测试场景**:
- 系统重启恢复
- 异常订单恢复
- 并发异常恢复

**示例输出**:
```
📊 异常恢复测试总结:
  ✅ 系统重启恢复
  ✅ 异常订单恢复
  ✅ 并发异常恢复
```

#### 5️⃣ 因子计算性能测试

**测试数据量**: 1K, 5K, 10K, 50K

**测试因子**:
- MA20 (移动平均)
- RSI (相对强弱指标)
- MACD (指数平滑移动平均)

**示例输出**:
```
📊 测试数据量: 10000条
  MA20:  1.82ms (5495 样本/秒)
  RSI:   1.73ms (5780 样本/秒)
  MACD:  2.05ms (4878 样本/秒)
```

### 测试结果

测试完成后会生成JSON结果文件:
```
performance_stress_test_results_20251107_143500.json
```

---

## 测试报告

### 📝 自动生成报告

运行`run_all_tests.py`会自动生成报告,或手动生成:

```bash
python tests/test_report_generator.py
```

### 报告内容

生成的Markdown报告包含:

1. **📊 执行摘要**
   - 总测试数
   - 通过/失败数
   - 成功率
   - 测试状态 (优秀/良好/需要改进)

2. **🔄 实盘交易测试**
   - 测试结果表格
   - 性能指标 (延迟)

3. **🏋️ 性能压力测试**
   - 测试结果表格
   - 详细性能指标

4. **🔍 问题诊断**
   - 发现的问题
   - 警告信息

5. **💡 改进建议**
   - 按优先级分类 (高/中/低)
   - 具体优化建议

### 报告示例

```markdown
# 🧪 Qilin Stack 测试报告

**生成时间**: 2025-11-07 14:30:45

## 📊 执行摘要

- **总测试数**: 10
- **通过**: 10 ✅
- **失败**: 0 ❌
- **成功率**: 100.0%

### ✅ 测试状态: 优秀

---

## 🔄 实盘交易测试

| 测试项 | 状态 | 耗时 | 备注 |
|--------|------|------|------|
| 基础订单执行测试 | ✅ 通过 | 2.34s | |
| 多标的交易测试 | ✅ 通过 | 1.87s | 成功率: 100.0% |
| 风控机制验证测试 | ✅ 通过 | 1.52s | |
| 持仓跟踪测试 | ✅ 通过 | 2.01s | |
| 系统延迟测量 | ✅ 通过 | 3.45s | 平均延迟: 45.23ms |

...
```

---

## 常见问题

### ❓ 导入错误

**问题**: `ImportError: No module named 'trading'`

**解决**:
```bash
# 确保在项目根目录运行
cd G:\test\qilin_stack
python run_all_tests.py
```

### ❓ 缺少依赖

**问题**: `ModuleNotFoundError: No module named 'psutil'`

**解决**:
```bash
pip install psutil numpy
```

### ❓ 测试失败率高

**可能原因**:
1. 系统资源不足 (CPU/内存)
2. 其他程序占用端口
3. 代码有bug

**解决**:
1. 关闭其他程序
2. 降低并发测试数量
3. 查看详细错误日志

### ❓ 内存泄漏警告

**判断标准**: 
- 平均增长 > 5MB/轮
- 内存增长率 > 0.1MB/秒

**解决**:
1. 检查是否正确释放资源
2. 检查是否存在循环引用
3. 使用Python内存分析工具

### ❓ Ptrade/QMT连接失败

**可能原因**:
1. 客户端未启动
2. 账号信息错误
3. 路径配置错误

**解决**:
1. 启动迅投客户端
2. 检查account_id是否正确
3. 检查client_path路径

---

## 📞 技术支持

### 查看日志

所有测试都会输出详细日志到控制台,包括:
- ✅ 成功信息
- ❌ 错误信息
- ⚠️ 警告信息

### 问题反馈

如果遇到问题:
1. 查看完整错误堆栈
2. 检查测试结果JSON文件
3. 查看测试报告的"问题诊断"部分

---

## 🎯 最佳实践

### 1️⃣ 定期测试

**建议频率**:
- 代码修改后: 立即测试
- 每日构建: 自动运行
- 发布前: 完整测试

### 2️⃣ 渐进测试

**测试顺序**:
1. 先运行实盘测试 (快速验证功能)
2. 再运行压力测试 (验证性能)
3. 最后生成报告 (分析结果)

### 3️⃣ 持续监控

**监控指标**:
- 成功率趋势
- 延迟趋势
- 内存使用趋势
- 错误率趋势

### 4️⃣ 问题处理

**处理流程**:
1. 发现问题 → 查看详细日志
2. 定位问题 → 查看堆栈跟踪
3. 修复问题 → 重新运行测试
4. 验证修复 → 确保测试通过

---

## 📚 相关文档

- [项目完成报告](FINAL_PROJECT_REPORT.md)
- [P2完成报告](P2_FINAL_COMPLETION_REPORT.md)
- [使用示例](examples/)

---

**Qilin Stack - 让量化交易测试更简单** 🚀
