# 缠论增强策略配置
#
# 功能: 融合缠论评分与麒麟 Qlib 因子
# 策略: ChanLunEnhancedStrategy (继承 TopkDropoutStrategy)
#
# 使用方式:
#   qrun run --config_path configs/chanlun/enhanced_strategy.yaml
#
# 作者: Warp AI Assistant
# 日期: 2025-01
# 项目: 麒麟量化系统 - Phase 2 重构

qlib_init:
    provider_uri: "~/.qlib/qlib_data/cn_data"
    region: cn

market: csi300

data_handler_config: &data_handler_config
    start_time: 2020-01-01
    end_time: 2023-12-31
    fit_start_time: 2020-01-01
    fit_end_time: 2022-12-31
    instruments: csi300
    infer_processors:
        - class: RobustZScoreNorm
          kwargs:
              fields_group: feature
              clip_outlier: true
        - class: Fillna
          kwargs:
              fields_group: feature
    learn_processors:
        - class: DropnaLabel
        - class: CSRankNorm
          kwargs:
              fields_group: label
    label: ["Ref($close, -2) / Ref($close, -1) - 1"]

# Handler: 使用混合Handler加载缠论特征
handler:
    class: HybridChanLunHandler
    module_path: qlib_enhanced.chanlun.hybrid_handler
    kwargs: *data_handler_config

# 数据集配置
dataset:
    class: DatasetH
    module_path: qlib.data.dataset
    kwargs:
        handler:
            class: HybridChanLunHandler
            module_path: qlib_enhanced.chanlun.hybrid_handler
            kwargs: *data_handler_config
        segments:
            train: [2020-01-01, 2021-12-31]
            valid: [2022-01-01, 2022-06-30]
            test: [2022-07-01, 2023-12-31]

# 模型: 可以使用 LightGBM 或 ChanLunScoringModel
# 选项1: 使用 LightGBM (推荐 - 融合缠论特征和传统因子)
model:
    class: LGBModel
    module_path: qlib.contrib.model.gbdt
    kwargs:
        loss: mse
        colsample_bytree: 0.8879
        learning_rate: 0.0421
        subsample: 0.8789
        lambda_l1: 205.6999
        lambda_l2: 580.9768
        max_depth: 8
        num_leaves: 210
        num_threads: 20

# 选项2: 使用缠论评分模型 (取消注释使用)
# model:
#     class: ChanLunScoringModel
#     module_path: models.chanlun_model
#     kwargs:
#         morphology_weight: 0.40
#         bsp_weight: 0.35
#         divergence_weight: 0.15
#         multi_level_weight: 0.10
#         enable_bsp: true
#         enable_divergence: true
#         use_multi_level: false

# 策略: 缠论增强策略
strategy:
    class: ChanLunEnhancedStrategy
    module_path: strategies.chanlun_qlib_strategy
    kwargs:
        # 模型信号
        signal: <MODEL>
        
        # 缠论配置
        chanlun_weight: 0.35         # 缠论评分权重 (35%)
        use_chanlun: true            # 启用缠论评分
        
        # TopK 策略参数
        topk: 30                     # 持仓股票数量
        n_drop: 5                    # 每次最多卖出数量
        method_sell: "bottom"        # 卖出最低评分的股票
        method_buy: "top"            # 买入最高评分的股票
        hold_thresh: 1               # 持仓阈值
        only_tradable: true          # 只交易可交易股票

# 回测执行器
backtest:
    start_time: 2022-07-01
    end_time: 2023-12-31
    account: 100000000               # 初始资金: 1亿
    benchmark: SH000300              # 基准: 沪深300
    exchange_kwargs:
        freq: day                    # 交易频率: 日频
        limit_threshold: 0.095       # 涨跌停阈值: 9.5%
        deal_price: close            # 成交价格: 收盘价
        open_cost: 0.0005            # 买入手续费: 0.05%
        close_cost: 0.0015           # 卖出手续费: 0.15% (含印花税)
        min_cost: 5                  # 最低手续费: 5元

# 记录器配置
record:
    - class: SignalRecord
      module_path: qlib.workflow.record_temp
      kwargs: {}
    - class: SigAnaRecord
      module_path: qlib.workflow.record_temp
      kwargs:
          ana_long_short: false
          ann_scaler: 252
    - class: PortAnaRecord
      module_path: qlib.workflow.record_temp
      kwargs:
          config: *data_handler_config

# 工作流名称
exp_name: chanlun_enhanced_strategy
